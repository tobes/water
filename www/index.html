<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
  <link rel="manifest" href="/img/site.webmanifest">
  <title>Water System</title>
  <link rel="static/stylesheet" href="style.css">
  <style>
    div {
      text-align: center;
    }

    #message_raw {
      text-align: left;
      max-width: 200px;
      margin: auto;
    }

    .j_string {
      color: green;
    }

    .j_number {
      color: darkorange;
    }

    .j_boolean {
      color: blue;
    }

    .j_null {
      color: magenta;
    }

    .j_key {
      color: red;
    }

    table {
      border-collapse: collapse;
      margin: 25px auto;
      font-size: 0.9em;
      font-family: sans-serif;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
    }

    thead tr {
      background-color: #009879;
      color: #ffffff;
      text-align: left;
    }

    th,
    td {
      padding: 12px 15px;
    }

    tbody tr {
      border-bottom: 1px solid #dddddd;
    }

    tbody tr:nth-of-type(even) {
      background-color: #f3f3f3;
    }

    tbody tr:last-of-type {
      border-bottom: 2px solid #009879;
    }

    th.int,
    th.float,
    th.seconds,
    td.int,
    td.float,
    td.seconds {
      text-align: right;
    }
  </style>
</head>

<body>
  <div id="main">
    <h1>Water System</h1>

    <div>
      <div><span id="temp">-</span>Â°C</div>
      <img id="icon">
      <div><span id="depth"></span> mm</div>
      <div><span id="volume"></span> litres</div>
      <div><span id="pump_state"></span></div>
      <div id="message_time"></div>
    </div>

    <div>
      <pre id="message_raw"></pre>
    </div>
  </div>
  <script>
    var update_timeout;
    var last_update = 0;
    const UPDATE_INTERVAL = 1000 * 60 * 15;

    function update(data)
    {

      //console.log(data);
      var w = data.weather.state;
      var temp = w.main.temp;
      var icon = w.weather[0].icon;
      var sensor = data['sensor 1'];
      var depth = sensor.depth;
      var volume = sensor.volume;
      var pump = data['pump 1'];
      var pump_state = pump.state

      const options = {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
	hour: "numeric",
	minute: "numeric",
	second: "numeric"
      };
      let message_time = new Date(data.message_time).toLocaleString('en-GB', options);

      document.getElementById("icon").src = "/img/" + icon + ".png"
      document.getElementById("temp").innerText = temp;
      document.getElementById("depth").innerText = depth;
      document.getElementById("volume").innerText = volume;
      document.getElementById("pump_state").innerText = pump_state;
      document.getElementById("message_time").innerText = message_time;
      return;
      var json = JSON.stringify(data, undefined, 4);
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g,
        '&gt;');
      json = json.replace(
        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        function(match)
        {
          var cls = 'j_number';
          if (/^"/.test(match))
          {
            if (/:$/.test(match))
            {
              cls = 'j_key';
            }
            else
            {
              cls = 'j_string';
            }
          }
          else if (/true|false/.test(match))
          {
            cls = 'j_boolean';
          }
          else if (/null/.test(match))
          {
            cls = 'j_null';
          }
          return '<span class="' + cls + '">' + match + '</span>';
        });
      document.getElementById("message_raw").innerHTML = json;
    }


    function next_update()
    {
      var now = new Date().getTime()
      if (now - last_update >= UPDATE_INTERVAL)
      {
        return 0;
      }
      return UPDATE_INTERVAL - now % UPDATE_INTERVAL
    }

    function request(url, callback)
    {
      // Creating Our XMLHttpRequest object
      var xhr = new XMLHttpRequest();
      // Making our connection
      xhr.open("GET", url, true);
      // function execute after request is successful
      xhr.onreadystatechange = function()
      {
        if (this.readyState == 4 && this.status == 200)
        {
          callback(JSON.parse(this.responseText));
        }
      }
      // Sending our request
      xhr.send();
    }

    function update_status()
    {
      if (update_timeout)
      {
        clearTimeout(update_timeout);
      }
      request('/status', update);

      last_update = new Date().getTime()
      update_timeout = setTimeout(update_status, next_update())
    }

    document.onvisibilitychange = () =>
    {
      if (document.visibilityState === 'hidden')
      {
        if (update_timeout)
        {
          clearTimeout(update_timeout);
        }

      }
      else
      {

        update_timeout = setTimeout(update_status, next_update())
      }
    };
    document.getElementById("main").addEventListener("click", update_status);

    function make_value(value, col_info)
    {
      if (col_info.type === 'date')
      {
        value = new Date(value).toLocaleDateString();
      }

      if (col_info.type === 'time')
      {
        value = value.substring(0, 5);
      }

      if (col_info.type === 'float')
      {
        value = value.toFixed(2)
      }

      if (col_info.type === 'seconds')
      {
        var minutes = Math.floor(value / 60);
        var seconds = value - minutes * 60;
        value = "" + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
      }

      if (col_info.units)
      {
        value += col_info.units;
      }
      return value;

    }


    function update_stats(data)
    {
      const cols = data.cols
      const values = data.values
      let table = document.createElement('table');
      let thead = document.createElement('thead');
      table.appendChild(thead);
      let tr = document.createElement('tr');
      thead.appendChild(tr);
      for (const col of cols)
      {
        let th = document.createElement('th');
        th.innerText = col.title;
        th.setAttribute('class', col.type);
        tr.appendChild(th);
      }
      let tbody = document.createElement('tbody');
      table.appendChild(tbody);
      values.forEach(row =>
      {
        let tr = document.createElement('tr');
        tbody.appendChild(tr);
        for (let i = 0; i < cols.length; i++)
        {
          let value = make_value(row[i], cols[i]);
          let td = document.createElement('td');
          td.setAttribute('class', cols[i].type);
          td.innerText = value;
          tr.appendChild(td);
        }

      });

      document.body.appendChild(table);
    }

    function stats()
    {
      request('/stats', update_stats);
      request('/stats_pump', update_stats);
      request('/stats_weather', update_stats);
    }

    update_status();
    stats();
  </script>
</body>

</html>
